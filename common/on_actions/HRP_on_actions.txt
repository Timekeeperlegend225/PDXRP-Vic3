on_monthly_pulse= {
    on_actions = {
    	america_migration_check 
	    power_bloc_leader_rank_check
		add_journal_for_age_if_needed
    }
}

on_monthly_pulse_country = {
    effect = {
		if = { 
			limit = {
				has_global_variable = age_of_concert_gm
				NOT = { has_journal_entry = je_HRP_concert_national }
			}
			add_journal_entry = {
				type = je_HRP_concert_national
			}
		}
		if = { 
			limit = {
				has_global_variable = gilded_age_gm
				NOT = { has_journal_entry = je_HRP_gilded_age }
				NOT = { has_journal_entry = je_HRP_gilded_age_gm }
			}
			add_journal_entry = {
				type = je_HRP_gilded_age
			}
		}
		if = { 
			limit = {
				has_global_variable = age_of_concert_gm
				NOT = { has_journal_entry = je_HRP_concert_global }
				NOT = { has_journal_entry = je_HRP_concert_global_gm }
			}
			add_journal_entry = {
				type = je_HRP_concert_global
			}
		}
		trigger_event = { id = unable_to_enact.1 }

		# British Monarchy
		if = {
			limit = {
				c:GBR ?= this
				game_date >= 1841.11.09
				ruler ?= {
					has_template = gbr_queen_victoria_template
				}
				NOT = {
					has_variable = edward_vii_heir_var
				}
			}
			create_character = {
				template = gbr_albert_edward_template
				heir = yes
			}
			set_variable = edward_vii_heir_var
		}
		if = {
			limit = {
				c:GBR ?= this
				game_date >= 1865.06.03
				ruler ?= {
					has_template = gbr_albert_edward_template
				}
				NOT = {
					exists = heir
				}
				NOT = {
					has_variable = george_v_heir_var
				}
			}
			create_character = {
				template = gbr_george_v_template
				heir = yes
			}
			set_variable = george_v_heir_var
		}
		if = {
			limit = {
				c:GBR ?= this
				game_date >= 1910.5.06
				ruler ?= {
					has_template = gbr_albert_edward_template
				}
				heir = {
					has_template = gbr_george_v_template
				}
				NOT = {
				has_variable = george_v_ruler_var
				}
			}
			trigger_event = { id = britain_monarchy.1 popup = yes }
		}

		# Sweden Monarchy event
		if = {
			limit = {
				c:SWE ?= this
				game_date >= 1859.6.29
				ruler ?= {
					has_template = swe_oscar_bernadotte_template
				}
				heir = {
					has_template = swe_charles_bernadotte_template
				}
			}
			trigger_event = { id = sweden_monarchy.2 popup = yes }
		}
		if = {
			limit = {
				c:SWE ?= this
				game_date >= 1859.6.29
				NOT = {
					ruler ?= {
						has_template = swe_oscar_bernadotte_template
					}
					has_variable = charles_xv_ruler_var
				}
			}
			set_variable = charles_xv_ruler_var
			create_character = {
				template = swe_oscar_ii_bernadotte_template
				heir = yes
				is_admiral = yes
			}
			if = {
				limit = {
					any_scope_character = {
						has_template = swe_charles_bernadotte_template
					}
				}
				random_scope_character = {
					limit = {
						has_template = swe_charles_bernadotte_template
					}
					add_trait = cancer
				}
			}
		}

		if = {
			limit = {
		    	c:SWE ?= this
		    	game_date >= 1872.9.29
		    	any_scope_character = {
		    		is_ruler = yes
		    		has_template = swe_charles_bernadotte_template
		    	}
		    	any_scope_character = {
		    		is_heir = yes
		    		has_template = swe_oscar_ii_bernadotte_template
		    	}
		    }
			trigger_event = { id = sweden_monarchy.3 popup = yes }
		}

    	if = {
    		limit = {
		    	c:SWE ?= this
		    	game_date >= 1872.9.29
		    	any_scope_character = {
		       		is_ruler = yes
		       		has_template = swe_oscar_ii_bernadotte_template
		    	}
		    	NOT = {
		       		has_variable = oscar_ii_ruler_var
		    	}
		    }
			create_character = {
				template = swe_gustaf_v_bernadotte_template
				heir = yes
			}
			set_variable = oscar_ii_ruler_var
    	}

		if = {
			limit = {
				c:GBR ?= this
				game_date >= 1850.1.1
				NOT = {
				has_variable = nightingale_var
				}
			}
			create_character = {
				template = GBR_florence_nightingale
				on_created = {
					if = {
						limit = { is_in_exile_pool = no }
						exile_character = yes
					}
				}
			}
			set_variable = nightingale_var
		}

		# Japan
		if = {
			limit = {
				c:JAP ?= this
				has_variable = meiji_restoration_complete
				has_law = law_type:law_monarchy
			}
			if = {
				limit = {
					year >= 1852
					NOT = { has_variable = heir_meiji_spawned }
					ruler ?= {
						has_template = JAP_komei_yamato
					}
					NOT = { exists = heir }
				}
				create_character = {
					template = JAP_meiji_yamato
				}
				set_variable = heir_meiji_spawned
			}
			else_if = {
				limit = {
					year >= 1879
					NOT = { has_variable = heir_taisho_spawned }
					ruler ?= {
						has_template = JAP_meiji_yamato
					}
					NOT = { exists = heir }
				}
				create_character = {
					template = JAP_taisho_yamato
				}
				set_variable = heir_taisho_spawned
			}
			else_if = {
				limit = {
					year >= 1901
					NOT = { has_variable = heir_showa_spawned }
					ruler ?= {
						has_template = JAP_taisho_yamato
					}
					NOT = { exists = heir }
				}
				create_character = {
					template = JAP_showa_yamato
				}
				set_variable = heir_showa_spawned
			}
		}

		# TODO: Move these to tag-specific pulses
		if = {
			limit = {
				c:FRA ?= this
				c:FRA ?= {
					OR = {
						has_modifier = modifier_haitian_independence_payments_1
						has_modifier = modifier_haitian_independence_payments_2
						has_modifier = modifier_haitian_independence_payments_3
						has_modifier = modifier_haitian_independence_payments_4
					}
				}
				NOT = { exists = c:HAI }
			}
			c:FRA = {
				if = {
					limit = {
						has_modifier = modifier_haitian_independence_payments_1
					}
					remove_modifier = modifier_haitian_independence_payments_1
				}
				if = {
					limit = {
						has_modifier = modifier_haitian_independence_payments_2
					}
					remove_modifier = modifier_haitian_independence_payments_2
				}
				if = {
					limit = {
						has_modifier = modifier_haitian_independence_payments_3
					}
					remove_modifier = modifier_haitian_independence_payments_3
				}
				if = {
					limit = {
						has_modifier = modifier_haitian_independence_payments_4
					}
					remove_modifier = modifier_haitian_independence_payments_4
				}
			}
		}
		if = { # Removes the Berar lease modifier if no longer relevant
			limit = {
				c:BIC ?= this
				c:BIC ?= {
					has_modifier = lease_of_berar_costs
				}
				OR = {
					NOT = { exists = c:HYD }
					c:BIC ?= {
						has_war_with = c:HYD
					}
					c:BIC = {
						NOT = {
							any_scope_state = {
								state_region = s:STATE_CENTRAL_PROVINCES
							}
						}
					}
				}
			}
			c:BIC ?= {
				remove_modifier = lease_of_berar_costs
			}
			c:HYD ?= {
				remove_modifier = lease_of_berar_income
			}
		}
		if = { #Exists to make sure independent Perus get this ASAP.
			limit = {
				OR = {
					c:NPU ?= this
					c:SPU ?= this
				}
				is_subject = no
				NOT = {
					has_variable = peru_has_claims
				}
				OR = {
					AND = { #SPU is either dead or a puppet, will not fire if it is independent.
						c:NPU ?= this
						OR = {
							NOT = {
								exists = c:SPU
							}
							c:SPU ?= { is_subject = yes }
						}
					}
					AND = {
						c:SPU ?= this
						OR = {
							NOT = {
								exists = c:SPU
							}
							c:NPU ?= { is_subject = yes }
						}
					}
				}
			}
			trigger_event = { id = peru_bolivia_events.8 days = 0 popup = yes }
		}

		if = {
			limit = {
				is_country_type = colonial # The colonial country type, for now, is only used for colonies whilst they are subjects of another power
				is_subject = no
			}
			set_country_type = recognized
		}

		if = { # Creates Petrograd
			limit = {
				country_has_primary_culture = cu:russian
				has_technology_researched = nationalism
				NOT = { has_law = law_type:law_council_republic }

				OR = {
					any_rival_country = {
						any_primary_culture = {
							has_discrimination_trait = german_speaking
						}
					}
					any_rivaling_country = {
						any_primary_culture = {
							has_discrimination_trait = german_speaking
						}
					}
				}
				any_scope_state = {
					state_region = s:STATE_INGRIA
				}
				NOT = {
					has_variable = petrograd_var
				}
			}
			set_variable = petrograd_var
			random_scope_state = {
				limit = {
					state_region = s:STATE_INGRIA
				}
				if = {
					limit = {
						has_global_variable = lenin_spawn

						owner = {
							country_has_primary_culture = cu:russian
							has_law = law_type:law_council_republic
						}
					}

			        set_hub_name = {
			            type = city
			            name = HUB_NAME_STATE_INGRIA_city_russian_sov # St. Petersburg only becomes Leningrad if Lenin has been around to be a namesake
			        }
				}
			}
		}
	}
}

america_migration_check = {
    effect = {
        every_country = {
            limit = {
                OR = {
                    country_is_in_north_america = yes
					country_is_in_central_america = yes
                    country_is_in_south_america = yes
                }
            }
			if = {
				limit = {
					country_rank = rank_value:great_power 
					NOT = { has_modifier = american_migration_gp_attraction }
				}
				add_modifier = american_migration_gp_attraction
				remove_modifier =  american_migration_mp_attraction
			}
			else_if = {
				limit = {
					country_rank = rank_value:major_power
					NOT = { has_modifier = american_migration_mp_attraction } 
				}
				add_modifier = american_migration_mp_attraction
				remove_modifier =  american_migration_gp_attraction
			}
			else_if = {
				limit = {   
					OR = {
						country_rank = rank_value:minor_power
						country_rank = rank_value:insignificant_power
					}   
					OR = {
						has_modifier = american_migration_mp_attraction
						has_modifier =  american_migration_gp_attraction
					}
				}
			}
        }
    }
}

power_bloc_leader_rank_check = {
    effect = {
        every_power_bloc = {
            if = {
                limit = {
			        power_bloc_leader = { country_rank = rank_value:major_power}
                    NOT = {has_modifier = power_bloc_led_by_major}
                }
                add_modifier = power_bloc_led_by_major
                remove_modifier  = power_bloc_led_by_minor
            }
            else_if = {
                limit = {
                    power_bloc_leader = { country_rank = rank_value:minor_power}
                    NOT = {has_modifier = power_bloc_led_by_minor}
                }
                add_modifier = power_bloc_led_by_minor
                remove_modifier  = power_bloc_led_by_major
            }
            else_if = {
                limit = {
                    power_bloc_leader = { country_rank = rank_value:great_power}
                    OR = {
                    has_modifier = power_bloc_led_by_minor
                    has_modifier = power_bloc_led_by_major
                    }
                }
                remove_modifier  = power_bloc_led_by_major
                remove_modifier  = power_bloc_led_by_minor
            }
        }
    }
}